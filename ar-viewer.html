<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Dinosaur Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        .controls h2 {
            margin: 0 0 15px 0;
            color: #ff6b6b;
        }

        .model-selector {
            margin-bottom: 15px;
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #333;
            color: white;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        .btn.active {
            background: #4CAF50;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 12px;
        }

        .status.success {
            background: #4CAF50;
        }

        .status.error {
            background: #f44336;
        }

        .status.loading {
            background: #ff9800;
        }

        .model-info {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ar-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            text-align: center;
            z-index: 100;
        }

        .ar-overlay h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }

        .ar-overlay p {
            margin: 0;
            font-size: 14px;
        }

        .touch-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .touch-btn {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .touch-btn:hover {
            background: rgba(255, 82, 82, 1);
        }

        @media (max-width: 768px) {
            .controls {
                max-width: 250px;
                padding: 15px;
            }
            
            .button-group {
                gap: 5px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="controls">
            <h2>ü¶ï AR Dinosaur Viewer</h2>
            
            <div class="model-selector">
                <label for="modelSelect">Select Dinosaur:</label>
                <select id="modelSelect">
                    <option value="">Choose a model...</option>
                    <option value="triceratops.glb">Triceratops</option>
                    <option value="T-Rex.glb">T-Rex</option>
                    <option value="stegosaurus.glb">Stegosaurus</option>
                    <option value="brontosaurus.glb">Brontosaurus</option>
                    <option value="spinosaurus.glb">Spinosaurus</option>
                    <option value="raptor.glb">Raptor</option>
                    <option value="ankylosaurus.glb">Ankylosaurus</option>
                    <option value="gallimimus.glb">Gallimimus</option>
                    <option value="pachycephalosaurus.glb">Pachycephalosaurus</option>
                    <option value="plesiasaurus.glb">Plesiosaurus</option>
                    <option value="ichthyosaur.glb">Ichthyosaur</option>
                    <option value="mozazaur.glb">Mosasaurus</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn" id="startCameraBtn">üì∑ Start Camera</button>
                <button class="btn" id="loadModelBtn" disabled>üì• Load Model</button>
                <button class="btn" id="randomBtn" disabled>üé≤ Random</button>
            </div>

            <div class="button-group">
                <button class="btn" id="resetBtn" disabled>üîÑ Reset</button>
                <button class="btn" id="animateBtn" disabled>üé≠ Animate</button>
                <button class="btn" id="scaleBtn" disabled>üìè Scale</button>
            </div>

            <div id="status" class="status">Click "Start Camera" to begin</div>
            
            <div id="modelInfo" class="model-info" style="display: none;">
                <strong>Model Info:</strong><br>
                <span id="modelName">-</span><br>
                <span id="modelSize">-</span><br>
                <span id="modelAnimations">-</span>
            </div>
        </div>

        <div class="ar-overlay" id="arOverlay" style="display: none;">
            <h3>ü•Ω AR Mode Active</h3>
            <p>Point your camera at a flat surface to place the dinosaur</p>
        </div>

        <div class="touch-controls" id="touchControls" style="display: none;">
            <button class="touch-btn" id="moveBtn" title="Move Dinosaur">üéÆ</button>
            <button class="touch-btn" id="rotateBtn" title="Rotate">üîÑ</button>
            <button class="touch-btn" id="scaleBtn" title="Scale">üìè</button>
            <button class="touch-btn" id="animateBtn" title="Animate">üé≠</button>
        </div>
    </div>

    <!-- Three.js and GLTFLoader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        class ARViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.model = null;
                this.mixer = null;
                this.animations = null;
                this.video = null;
                this.isCameraActive = false;
                this.isModelLoaded = false;
                this.isMoving = false;
                this.lastTouch = null;
                this.modelPosition = { x: 0, y: 0, z: 0 };
                this.modelScale = 1;
                this.modelRotation = 0;
                
                this.init();
                this.setupEventListeners();
            }

            async init() {
                try {
                    // Setup Three.js scene
                    this.scene = new THREE.Scene();
                    this.scene.background = null; // Transparent for AR
                    
                    // Setup camera
                    this.camera = new THREE.PerspectiveCamera(
                        75,
                        window.innerWidth / window.innerHeight,
                        0.1,
                        1000
                    );
                    this.camera.position.set(0, 0, 5);
                    
                    // Setup renderer
                    const canvas = document.getElementById('canvas');
                    this.renderer = new THREE.WebGLRenderer({
                        canvas: canvas,
                        antialias: true,
                        alpha: true
                    });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    
                    // Add lighting
                    this.setupLighting();
                    
                    // Handle window resize
                    window.addEventListener('resize', () => this.onWindowResize());
                    
                    this.updateStatus('Ready to start camera', 'success');
                    
                    // Start render loop
                    this.animate();
                    
                } catch (error) {
                    console.error('Failed to initialize AR viewer:', error);
                    this.updateStatus('Failed to initialize', 'error');
                }
            }

            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // Directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                // Point light
                const pointLight = new THREE.PointLight(0xff6b6b, 0.5, 100);
                pointLight.position.set(0, 5, 0);
                this.scene.add(pointLight);
            }

            async startCamera() {
                try {
                    this.updateStatus('Starting camera...', 'loading');
                    
                    this.video = document.getElementById('video');
                    
                    // Request camera access
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment', // Use back camera
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    this.isCameraActive = true;
                    
                    // Enable model loading buttons
                    document.getElementById('loadModelBtn').disabled = false;
                    document.getElementById('randomBtn').disabled = false;
                    
                    this.updateStatus('Camera started! Load a model to begin AR', 'success');
                    
                } catch (error) {
                    console.error('Failed to start camera:', error);
                    this.updateStatus('Camera access denied or not available', 'error');
                }
            }

            async loadModel(modelPath) {
                if (!this.isCameraActive) {
                    this.updateStatus('Please start camera first', 'error');
                    return;
                }

                try {
                    this.updateStatus('Loading model...', 'loading');
                    
                    // Remove existing model
                    if (this.model) {
                        this.scene.remove(this.model);
                        this.model = null;
                    }

                    // Load GLTF model
                    const loader = new THREE.GLTFLoader();
                    
                    const gltf = await new Promise((resolve, reject) => {
                        loader.load(
                            modelPath,
                            resolve,
                            (progress) => {
                                const percent = Math.round((progress.loaded / progress.total) * 100);
                                this.updateStatus(`Loading... ${percent}%`, 'loading');
                            },
                            reject
                        );
                    });

                    // Add model to scene
                    this.model = gltf.scene;
                    this.model.position.set(0, -2, 0); // Place on ground
                    this.model.scale.set(0.5, 0.5, 0.5); // Scale down for AR
                    
                    // Enable shadows
                    this.model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    this.scene.add(this.model);
                    
                    // Setup animations
                    if (gltf.animations && gltf.animations.length > 0) {
                        this.mixer = new THREE.AnimationMixer(this.model);
                        this.animations = gltf.animations;
                        this.updateStatus(`Model loaded with ${gltf.animations.length} animations`, 'success');
                    } else {
                        this.updateStatus('Model loaded successfully', 'success');
                    }
                    
                    // Enable AR controls
                    this.enableARControls();
                    this.updateModelInfo(modelPath, gltf);
                    this.isModelLoaded = true;
                    
                } catch (error) {
                    console.error('Failed to load model:', error);
                    this.updateStatus(`Failed to load model: ${error.message}`, 'error');
                }
            }

            async loadRandomModel() {
                const models = [
                    'triceratops.glb', 'T-Rex.glb', 'stegosaurus.glb', 'brontosaurus.glb',
                    'spinosaurus.glb', 'raptor.glb', 'ankylosaurus.glb', 'gallimimus.glb',
                    'pachycephalosaurus.glb', 'plesiasaurus.glb', 'ichthyosaur.glb', 'mozazaur.glb'
                ];
                
                const randomModel = models[Math.floor(Math.random() * models.length)];
                this.loadModel(`models/${randomModel}`);
            }

            enableARControls() {
                // Show AR overlay
                document.getElementById('arOverlay').style.display = 'block';
                document.getElementById('touchControls').style.display = 'flex';
                
                // Enable control buttons
                document.getElementById('resetBtn').disabled = false;
                document.getElementById('animateBtn').disabled = false;
                document.getElementById('scaleBtn').disabled = false;
            }

            setupEventListeners() {
                document.getElementById('startCameraBtn').addEventListener('click', () => {
                    this.startCamera();
                });

                document.getElementById('loadModelBtn').addEventListener('click', () => {
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect.value) {
                        this.loadModel(`models/${modelSelect.value}`);
                    } else {
                        this.updateStatus('Please select a model first', 'error');
                    }
                });

                document.getElementById('randomBtn').addEventListener('click', () => {
                    this.loadRandomModel();
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetModel();
                });

                document.getElementById('animateBtn').addEventListener('click', () => {
                    this.animateModel();
                });

                document.getElementById('scaleBtn').addEventListener('click', () => {
                    this.scaleModel();
                });

                // Touch controls
                document.getElementById('moveBtn').addEventListener('click', () => {
                    this.toggleMoveMode();
                });

                document.getElementById('rotateBtn').addEventListener('click', () => {
                    this.rotateModel();
                });

                // Touch events for mobile
                const canvas = document.getElementById('canvas');
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.isMoving && this.model) {
                        this.lastTouch = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY
                        };
                    }
                });

                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.isMoving && this.lastTouch && this.model) {
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - this.lastTouch.x;
                        const deltaY = touch.clientY - this.lastTouch.y;
                        
                        this.moveModel(deltaX, deltaY);
                        
                        this.lastTouch = {
                            x: touch.clientX,
                            y: touch.clientY
                        };
                    }
                });

                canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.lastTouch = null;
                });
            }

            resetModel() {
                if (this.model) {
                    this.model.position.set(0, -2, 0);
                    this.model.rotation.set(0, 0, 0);
                    this.model.scale.set(0.5, 0.5, 0.5);
                    this.modelScale = 0.5;
                    this.modelRotation = 0;
                    this.updateStatus('Model reset', 'success');
                }
            }

            rotateModel() {
                if (this.model) {
                    this.modelRotation += Math.PI / 4;
                    this.model.rotation.y = this.modelRotation;
                    this.updateStatus('Model rotated', 'success');
                }
            }

            scaleModel() {
                if (this.model) {
                    this.modelScale = this.modelScale > 0.5 ? 0.2 : 1.0;
                    this.model.scale.set(this.modelScale, this.modelScale, this.modelScale);
                    this.updateStatus(`Model scaled to ${this.modelScale}x`, 'success');
                }
            }

            animateModel() {
                if (this.mixer && this.animations && this.animations.length > 0) {
                    const randomIndex = Math.floor(Math.random() * this.animations.length);
                    const clip = this.animations[randomIndex];
                    const action = this.mixer.clipAction(clip);
                    action.reset();
                    action.play();
                    this.updateStatus(`Playing animation: ${clip.name}`, 'success');
                } else {
                    this.updateStatus('No animations available', 'error');
                }
            }

            toggleMoveMode() {
                this.isMoving = !this.isMoving;
                const moveBtn = document.getElementById('moveBtn');
                if (this.isMoving) {
                    moveBtn.style.background = 'rgba(76, 175, 80, 0.9)';
                    this.updateStatus('Move mode: Touch and drag to move dinosaur', 'success');
                } else {
                    moveBtn.style.background = 'rgba(255, 107, 107, 0.9)';
                    this.updateStatus('Move mode off', 'success');
                }
            }

            moveModel(deltaX, deltaY) {
                if (this.model) {
                    const sensitivity = 0.01;
                    this.model.position.x += deltaX * sensitivity;
                    this.model.position.z -= deltaY * sensitivity;
                }
            }

            updateModelInfo(modelPath, gltf) {
                const modelInfo = document.getElementById('modelInfo');
                const modelName = document.getElementById('modelName');
                const modelSize = document.getElementById('modelSize');
                const modelAnimations = document.getElementById('modelAnimations');
                
                const fileName = modelPath.split('/').pop();
                modelName.textContent = `File: ${fileName}`;
                modelSize.textContent = `Size: ${gltf.scene.children.length} objects`;
                modelAnimations.textContent = `Animations: ${gltf.animations ? gltf.animations.length : 0}`;
                
                modelInfo.style.display = 'block';
            }

            updateStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                
                if (type === 'loading') {
                    status.innerHTML = `<div class="loading-spinner"></div>${message}`;
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update animation mixer
                if (this.mixer) {
                    this.mixer.update(0.016);
                }
                
                // Gentle floating animation for AR
                if (this.model && this.isModelLoaded) {
                    this.model.position.y = -2 + Math.sin(Date.now() * 0.001) * 0.1;
                }
                
                this.renderer.render(this.scene, this.camera);
            }

            onWindowResize() {
                if (this.camera && this.renderer) {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            }
        }

        // Initialize the AR viewer
        window.addEventListener('load', () => {
            new ARViewer();
        });
    </script>
</body>
</html>
